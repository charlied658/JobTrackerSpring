<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Scheduler</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <style>
        .container {
            display: flex;
            gap: 2rem;
        }

        .sidebar {
            min-width: 200px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .card {
            background-color: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .add-tile {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px dashed #ccc;
            background-color: #f9f9f9;
            text-align: center;
        }

        .plus-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid #666;
            font-size: 2rem;
            line-height: 56px;
            text-align: center;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>

<nav style="margin-bottom: 20px;">
    <a href="/view/jobs">ðŸ“‹ Jobs by Customer</a> |
    <span style="color: gray;">ðŸ“… Calendar View</span>
</nav>

<h1>
    <span th:text="${#temporals.format(selectedDate, 'MM/dd/yyyy - EEEE')}">Date</span>
</h1>

<div>
    <a th:href="@{/view/scheduler(date=${selectedDate.minusDays(1)})}">â¬… Previous Day</a> |
    <a th:href="@{/view/scheduler(date=${selectedDate.plusDays(1)})}">Next Day âž¡</a>
</div>

<div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
        <form action="/view/scheduler" method="get">
            <label for="date">Select Date:</label><br>
            <input type="date" id = "date" name="date"
                   th:value="${#temporals.format(selectedDate, 'yyyy-MM-dd')}"
                   onchange="this.form.submit()">
        </form>
        <br>
    </div>

    <!-- Main Grid -->
    <div class="grid">
        <!-- Service cards -->
        <div class="card" th:each="service : ${services}">
            <h3>
                <th:block th:if="${service.job != null}">
                    <a th:href="@{/jobs/{id}(id=${service.job.id})}" th:text="${service.job.customer}">View Job</a>
                </th:block>

                <th:block th:unless="${service.job != null}">
                    <span> Unlinked</span>
                </th:block>
            </h3>
            <p><strong>Crew:</strong> <span th:text="${service.crew}">Crew</span></p>
            <p><strong>Work:</strong> <span th:text="${service.workPerformed}">Work</span></p>
            <p><strong>Need:</strong> <em th:text="${service.need}">Need</em></p>

            <!-- Edit pencil button -->
            <button class="edit-btn"
                    onclick="openEditModal(this)"
                    th:attr="data-id=${service.id},
                             data-crew=${service.crew},
                             data-work=${service.workPerformed},
                             data-need=${service.need},
                             data-date=${service.date}">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#444" viewBox="0 0 16 16">
                    <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-9.5 9.5a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l9.5-9.5zm1.415 3.121L12.732 2 13 1.732 14.268 3l-.707.707zM11.025 2.732 13.268 5 6 12.268 3.757 10.025 11.025 2.732zM2.732 11.268 4 12.536 2.5 13l.5-1.5.732-.232z"/>
                </svg>
            </button>
        </div>

        <!-- Add Service tile -->
        <div class="card add-tile" onclick="openAddModal()">
            <div class="plus-circle">+</div>
            <p>Add Service</p>
        </a>
    </div>
</div>

<!-- Modal Overlay -->
<div id="editModalOverlay" class="modal-overlay" style="display: none;">
    <div class="modal-window">
        <!-- Top-right close button -->
        <button type="button" class="modal-close" onclick="closeEditModal()">âœ•</button>
        <h2>Edit Service</h2>
        <form id="editForm" method="post" action="/services/update">
            <input type="hidden" name="id" id="editServiceId">
            <input type="hidden" name="date" th:value="${selectedDate}" id ="editServiceDate">

            <label>Crew:</label><br>
            <input type="text" name="crew" id="editCrew"><br>

            <label>Work Performed:</label><br>
            <textarea name="workPerformed" id="editWork" rows="3"></textarea><br>

            <label>Need:</label><br>
            <textarea name="need" id="editNeed" rows="3"></textarea><br>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
                <button type="submit" class="modal-button save-button">ðŸ’¾ Save</button>
                <button type="button" class="modal-button delete-button" onclick="deleteService()">Delete</button>
            </div>
        </form>
    </div>
</div>

<div id="addModalOverlay" class="modal-overlay" style="display: none;">
    <div class="modal-window">
        <button type="button" class="modal-close" onclick="closeAddModal()">âœ•</button>
        <form id="addForm" method="post" th:action="@{/services/add}">
            <h3>Add Service</h3>

            <input type="hidden" name="date" id="addServiceDate" th:value="${selectedDate}" />

            <label for="addJobId">Customer:</label><br>
            <select name="jobId" id="addJobId" required>
                <option value="">-- Select a Customer --</option>
                <option th:each="job : ${allJobs}"
                        th:value="${job.id}"
                        th:text="${job.customer}">
                </option>
            </select><br><br>

            <label>Crew:</label><br>
            <input type="text" name="crew" id="addCrew"><br>

            <label>Work Performed:</label><br>
            <textarea name="workPerformed" id="addWork" rows="3"></textarea><br>

            <label>Need:</label><br>
            <textarea name="need" id="addNeed" rows="3"></textarea><br><br>

            <button type="submit" class="modal-button save-button">ðŸ’¾ Save</button>
        </form>
    </div>
</div>

</body>

<script>
    function openEditModal(button) {
        const id = button.getAttribute("data-id");
        const crew = button.getAttribute("data-crew");
        const work = button.getAttribute("data-work");
        const need = button.getAttribute("data-need");
        const date = button.getAttribute("data-date")

        document.getElementById('editServiceId').value = id;
        document.getElementById('editCrew').value = crew;
        document.getElementById('editWork').value = work;
        document.getElementById('editNeed').value = need;
        document.getElementById('editServiceDate').value = date;
        document.getElementById('editModalOverlay').style.display = 'flex';
    }

    function closeEditModal() {
        document.getElementById('editModalOverlay').style.display = 'none';
    }
</script>

<script>
    function openAddModal() {
        // Optionally reset fields
        document.getElementById('addCrew').value = '';
        document.getElementById('addWork').value = '';
        document.getElementById('addNeed').value = '';

        document.getElementById('addModalOverlay').style.display = 'flex';
    }

    function closeAddModal() {
        document.getElementById('addModalOverlay').style.display = 'none';
    }
</script>

<script>
    function deleteService() {
        const serviceId = document.getElementById('editServiceId').value;
        const serviceDate = document.getElementById('editServiceDate').value;
        if (confirm("Are you sure you want to delete this service?")) {
            const form = document.createElement('form');
            form.method = 'post';
            form.action = '/services/delete';

            const idInput = document.createElement('input');
            idInput.type = 'hidden';
            idInput.name = 'id';
            idInput.value = serviceId;

            const dateInput = document.createElement('input');
            dateInput.type = 'hidden';
            dateInput.name = 'date';
            dateInput.value = serviceDate;

            form.appendChild(idInput);
            form.appendChild(dateInput);
            document.body.appendChild(form);
            form.submit();
        }
    }
</script>

</html>